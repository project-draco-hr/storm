{
  long now=System.currentTimeMillis();
  if (now - lastRotate > rotateTime) {
    Map<Long,List<Object>> failed=idsMap.rotate();
    for (    List<Object> failedIds : failed.values()) {
      for (      Object id : failedIds) {
        _spout.fail(id);
      }
    }
    lastRotate=now;
  }
  _collector.reset(collector);
  if (!prepared) {
    _spout.open(_conf,_context,new SpoutOutputCollector(_collector));
    prepared=true;
  }
  for (int i=0; i < _maxBatchSize; i++) {
    _spout.nextTuple();
    if (_collector.numEmitted < i) {
      break;
    }
  }
  idsMap.put(tx.getTransactionId(),_collector.ids);
}
