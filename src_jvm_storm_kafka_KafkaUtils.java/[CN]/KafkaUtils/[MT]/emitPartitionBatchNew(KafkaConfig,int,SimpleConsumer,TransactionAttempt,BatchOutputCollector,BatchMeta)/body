{
  long offset=0;
  if (lastMeta != null) {
    offset=lastMeta.nextOffset;
  }
  ByteBufferMessageSet msgs;
  try {
    msgs=consumer.fetch(new FetchRequest(config.topic,partition % config.partitionsPerHost,offset,config.fetchSizeBytes));
  }
 catch (  Exception e) {
    if (e instanceof ConnectException) {
      throw new FailedFetchException(e);
    }
 else {
      throw new RuntimeException(e);
    }
  }
  long endoffset=offset;
  for (  Message msg : msgs) {
    emit(config,attempt,collector,msg);
    endoffset+=MessageSet.entrySize(msg);
  }
  BatchMeta newMeta=new BatchMeta();
  newMeta.offset=offset;
  newMeta.nextOffset=endoffset;
  return newMeta;
}
