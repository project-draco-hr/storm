{
  if (!Utils.isValidConf(stormConf)) {
    throw new IllegalArgumentException("Storm conf is not valid. Must be json-serializable");
  }
  stormConf=new HashMap(stormConf);
  stormConf.putAll(Utils.readCommandLineOpts());
  Map conf=Utils.readStormConfig();
  conf.putAll(stormConf);
  try {
    String serConf=JSONValue.toJSONString(stormConf);
    if (localNimbus != null) {
      LOG.info("Submitting topology " + name + " in local mode");
      localNimbus.submitTopology(name,null,serConf,topology);
    }
 else {
      NimbusClient client=NimbusClient.getConfiguredClient(conf);
      if (topologyNameExists(conf,name)) {
        throw new RuntimeException("Topology with name `" + name + "` already exists on cluster");
      }
      submitJar(conf);
      try {
        LOG.info("Submitting topology " + name + " in distributed mode with conf "+ serConf);
        client.getClient().submitTopologyWithOpts(name,submittedJar,serConf,topology,opts);
      }
 catch (      InvalidTopologyException e) {
        LOG.warn("Topology submission exception",e);
        throw e;
      }
catch (      AlreadyAliveException e) {
        LOG.warn("Topology already alive exception",e);
        throw e;
      }
 finally {
        client.close();
      }
    }
    LOG.info("Finished submitting topology: " + name);
  }
 catch (  TException e) {
    throw new RuntimeException(e);
  }
}
