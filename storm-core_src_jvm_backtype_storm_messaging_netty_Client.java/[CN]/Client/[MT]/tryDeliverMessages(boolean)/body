{
  if (only_if_waiting && !wait_for_requests)   return;
  Channel channel=channelRef.get();
  if (channel == null)   return;
  if (!channel.isOpen()) {
    LOG.info("Channel to {} is no longer open.",remote_addr);
    reconnect();
    return;
  }
  final MessageBatch requests=tryTakeMessages();
  if (requests == null) {
    wait_for_requests=true;
    return;
  }
  if (requests.isEmpty() && being_closed.get()) {
    close_n_release();
    return;
  }
  wait_for_requests=false;
  ChannelFuture future=channel.write(requests);
  future.addListener(new ChannelFutureListener(){
    public void operationComplete(    ChannelFuture future) throws Exception {
      if (!future.isSuccess()) {
        LOG.info("failed to send " + requests.size() + " requests to "+ remote_addr,future.getCause());
        reconnect();
      }
 else {
        LOG.debug("{} request(s) sent",requests.size());
        if (being_closed.get())         close_n_release();
      }
    }
  }
);
}
