{
  Object msg=message_queue.poll();
  if (msg == null)   return null;
  MessageBatch batch=new MessageBatch(buffer_size);
  if (msg == ControlMessage.CLOSE_MESSAGE) {
    LOG.info("Connection to {} is being closed",remote_addr);
    being_closed.set(true);
    return batch;
  }
  batch.add((TaskMessage)msg);
  while (!batch.isFull() && ((msg=message_queue.peek()) != null)) {
    if (msg == ControlMessage.CLOSE_MESSAGE) {
      message_queue.take();
      LOG.info("Connection to {} is being closed",remote_addr);
      being_closed.set(true);
      break;
    }
    if (!batch.tryAdd((TaskMessage)msg))     break;
    message_queue.take();
  }
  return batch;
}
