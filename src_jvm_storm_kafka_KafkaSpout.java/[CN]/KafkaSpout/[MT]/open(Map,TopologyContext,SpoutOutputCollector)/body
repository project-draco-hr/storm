{
  _collector=collector;
  Map stateConf=new HashMap(conf);
  List<String> zkServers=_spoutConfig.zkServers;
  if (zkServers == null)   zkServers=(List<String>)conf.get(Config.STORM_ZOOKEEPER_SERVERS);
  Integer zkPort=_spoutConfig.zkPort;
  if (zkPort == null)   zkPort=((Number)conf.get(Config.STORM_ZOOKEEPER_PORT)).intValue();
  String zkRoot=_spoutConfig.zkRoot;
  stateConf.put(Config.TRANSACTIONAL_ZOOKEEPER_SERVERS,zkServers);
  stateConf.put(Config.TRANSACTIONAL_ZOOKEEPER_PORT,zkPort);
  stateConf.put(Config.TRANSACTIONAL_ZOOKEEPER_ROOT,zkRoot);
  Config componentConf=new Config();
  componentConf.registerSerialization(ZooMeta.class);
  _state=TransactionalState.newUserState(stateConf,_spoutConfig.id,componentConf);
  if (_spoutConfig.hosts == null) {
    _partitions=new ZkKafkaPartitionConnections(_spoutConfig);
  }
 else {
    _partitions=new KafkaPartitionConnections(_spoutConfig);
  }
  int totalPartitions=_spoutConfig.partitionsPerHost * _spoutConfig.hosts.size();
  int numTasks=context.getComponentTasks(context.getThisComponentId()).size();
  for (int p=context.getThisTaskIndex(); p < totalPartitions; p+=numTasks) {
    _managedPartitions.add(p);
    _managers.put(p,new PartitionManager(p));
  }
}
