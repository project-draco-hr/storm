{
  try {
    _process.writeObject(query);
    while (true) {
      Map action=_process.readMap();
      if (action == null)       return;
      String command=(String)action.get("command");
      if (command.equals("log")) {
        String msg=(String)action.get("msg");
        LOG.info("Shell msg: " + msg);
      }
 else       if (command.equals("emit")) {
        String stream=(String)action.get("stream");
        if (stream == null)         stream=Utils.DEFAULT_STREAM_ID;
        Long task=(Long)action.get("task");
        List<Object> tuple=(List)action.get("tuple");
        Object messageId=(Object)action.get("id");
        if (task == null) {
          List<Integer> outtasks=_collector.emit(stream,tuple,messageId);
          _process.writeObject(outtasks);
        }
 else {
          _collector.emitDirect((int)task.longValue(),stream,tuple,messageId);
        }
      }
    }
  }
 catch (  IOException e) {
    throw new RuntimeException(e);
  }
}
