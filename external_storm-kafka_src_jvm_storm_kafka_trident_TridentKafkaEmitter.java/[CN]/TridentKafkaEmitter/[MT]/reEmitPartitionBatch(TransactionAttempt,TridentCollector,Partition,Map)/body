{
  LOG.info("re-emitting batch, attempt " + attempt);
  String instanceId=(String)meta.get("instanceId");
  if (!_config.forceFromStart || instanceId.equals(_topologyInstanceId)) {
    SimpleConsumer consumer=_connections.register(partition);
    long offset=(Long)meta.get("offset");
    long nextOffset=(Long)meta.get("nextOffset");
    ByteBufferMessageSet msgs=null;
    try {
      msgs=fetchMessages(consumer,partition,offset);
    }
 catch (    UpdateOffsetException e) {
      LOG.warn("OffsetOutOfRange during reEmitPartitionBatch, the transaction can not be replayed." + "Returning empty messages");
    }
    if (msgs != null) {
      for (      MessageAndOffset msg : msgs) {
        if (offset == nextOffset) {
          break;
        }
        if (offset > nextOffset) {
          throw new RuntimeException("Error when re-emitting batch. overshot the end offset");
        }
        emit(collector,msg.message());
        offset=msg.nextOffset();
      }
    }
  }
}
