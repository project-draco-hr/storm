{
  JedisCommandsInstanceContainer container;
  if (jedisPoolConfig != null) {
    container=JedisCommandsContainerBuilder.build(jedisPoolConfig);
  }
 else   if (jedisClusterConfig != null) {
    container=JedisCommandsContainerBuilder.build(jedisClusterConfig);
  }
 else {
    throw new IllegalArgumentException("Jedis configuration not found");
  }
  RedisMapState state=new RedisMapState(container,options,serializer,keyFactory);
  CachedMap c=new CachedMap(state,options.localCacheSize);
  MapState ms;
  if (type == StateType.NON_TRANSACTIONAL) {
    ms=NonTransactionalMap.build(c);
  }
 else   if (type == StateType.OPAQUE) {
    ms=OpaqueMap.build(c);
  }
 else   if (type == StateType.TRANSACTIONAL) {
    ms=TransactionalMap.build(c);
  }
 else {
    throw new RuntimeException("Unknown state type: " + type);
  }
  return new SnapshottableMap(ms,new Values(options.globalKey));
}
