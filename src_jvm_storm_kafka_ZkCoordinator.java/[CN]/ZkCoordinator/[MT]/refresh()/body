{
  try {
    LOG.info("Refreshing partition manager connections");
    Map<String,List> brokerInfo=_reader.getBrokerInfo();
    Set<GlobalPartitionId> mine=new HashSet();
    for (    String host : brokerInfo.keySet()) {
      List info=brokerInfo.get(host);
      long port=(Long)info.get(0);
      HostPort hp=new HostPort(host,(int)port);
      long numPartitions=(Long)info.get(1);
      for (int i=0; i < numPartitions; i++) {
        GlobalPartitionId id=new GlobalPartitionId(hp,i);
        if (myOwnership(id)) {
          mine.add(id);
        }
      }
    }
    Set<GlobalPartitionId> curr=_managers.keySet();
    Set<GlobalPartitionId> newPartitions=new HashSet<GlobalPartitionId>(mine);
    newPartitions.removeAll(curr);
    Set<GlobalPartitionId> deletedPartitions=new HashSet<GlobalPartitionId>(curr);
    deletedPartitions.removeAll(mine);
    LOG.info("Deleted partition managers: " + deletedPartitions.toString());
    for (    GlobalPartitionId id : deletedPartitions) {
      PartitionManager man=_managers.remove(id);
      man.close();
    }
    LOG.info("New partition managers: " + newPartitions.toString());
    for (    GlobalPartitionId id : newPartitions) {
      PartitionManager man=new PartitionManager(_connections,_topologyInstanceId,_config,_state,id);
      _managers.put(id,man);
    }
  }
 catch (  Exception e) {
    throw new RuntimeException(e);
  }
  _cachedList=new ArrayList<PartitionManager>(_managers.values());
  LOG.info("Finished refreshing");
}
