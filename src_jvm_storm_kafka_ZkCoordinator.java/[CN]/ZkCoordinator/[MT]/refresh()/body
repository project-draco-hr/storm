{
  try {
    LOG.info("Refreshing partition manager connections");
    String topicBrokersPath=_brokerConf.brokerZkPath + "/topics/" + _config.topic;
    String brokerInfoPath=_brokerConf.brokerZkPath + "/ids";
    List<String> children=_curator.getChildren().forPath(topicBrokersPath);
    Set<GlobalPartitionId> mine=new HashSet();
    for (    String c : children) {
      try {
        byte[] numPartitionsData=_curator.getData().forPath(topicBrokersPath + "/" + c);
        byte[] hostPortData=_curator.getData().forPath(brokerInfoPath + "/" + c);
        HostPort hp=getBrokerHost(hostPortData);
        int numPartitions=getNumPartitions(numPartitionsData);
        for (int i=0; i < numPartitions; i++) {
          GlobalPartitionId id=new GlobalPartitionId(hp,i);
          if (myOwnership(id)) {
            mine.add(id);
          }
        }
      }
 catch (      org.apache.zookeeper.KeeperException.NoNodeException e) {
      }
    }
    Set<GlobalPartitionId> curr=_managers.keySet();
    Set<GlobalPartitionId> newPartitions=new HashSet<GlobalPartitionId>(mine);
    newPartitions.removeAll(curr);
    Set<GlobalPartitionId> deletedPartitions=new HashSet<GlobalPartitionId>(curr);
    deletedPartitions.removeAll(mine);
    LOG.info("Deleted partition managers: " + deletedPartitions.toString());
    for (    GlobalPartitionId id : deletedPartitions) {
      PartitionManager man=_managers.remove(id);
      man.close();
    }
    LOG.info("New partition managers: " + newPartitions.toString());
    for (    GlobalPartitionId id : newPartitions) {
      PartitionManager man=new PartitionManager(_connections,_topologyInstanceId,_config,_state,id);
      _managers.put(id,man);
    }
  }
 catch (  Exception e) {
    throw new RuntimeException(e);
  }
  _cachedList=new ArrayList<PartitionManager>(_managers.values());
  LOG.info("Finished refreshing");
}
