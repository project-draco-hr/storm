{
  if (requests == null || requests.size() == 0 || being_closed.get())   return;
  Object last_msg=requests.get(requests.size() - 1);
  if (last_msg == ControlMessage.CLOSE_MESSAGE) {
    being_closed.set(true);
    requests.remove(last_msg);
  }
  if (requests.isEmpty()) {
    if (being_closed.get())     client.close_n_release();
    return;
  }
  ChannelFuture future=channel.write(requests);
  future.addListener(new ChannelFutureListener(){
    public void operationComplete(    ChannelFuture future) throws Exception {
      if (!future.isSuccess()) {
        LOG.info("failed to send requests:",future.getCause());
        future.getChannel().close();
      }
 else {
        LOG.debug("{} request(s) sent",requests.size());
      }
      if (being_closed.get())       client.close_n_release();
    }
  }
);
}
