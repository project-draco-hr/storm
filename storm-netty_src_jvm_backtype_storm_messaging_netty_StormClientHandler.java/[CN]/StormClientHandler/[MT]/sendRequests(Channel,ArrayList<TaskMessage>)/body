{
  if (being_closed.get())   return;
  TaskMessage last_msg=requests.get(requests.size() - 1);
  if (last_msg == Util.CLOSE_MESSAGE) {
    being_closed.set(true);
    requests.remove(last_msg);
  }
  if (requests.isEmpty()) {
    if (being_closed.get())     client.close_n_release();
    return;
  }
  requests.add(Util.EOB_MESSAGE);
  ChannelFuture future=channel.write(requests);
  future.addListener(new ChannelFutureListener(){
    public void operationComplete(    ChannelFuture future) throws Exception {
      if (!future.isSuccess()) {
        LOG.info("failed to send requests:",future.getCause());
        future.getChannel().close();
      }
 else {
        LOG.debug((requests.size() - 1) + " request(s) sent");
      }
      if (being_closed.get())       client.close_n_release();
    }
  }
);
}
