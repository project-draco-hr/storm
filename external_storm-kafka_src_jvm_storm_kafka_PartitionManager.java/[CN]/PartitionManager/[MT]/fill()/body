{
  long start=System.nanoTime();
  long offset;
  final SortedSet<Long> failedReady=failedMsgsReadyForRetry();
  final boolean had_failed=!failedReady.isEmpty();
  if (had_failed) {
    offset=failedReady.first();
  }
 else {
    offset=_emittedToOffset;
  }
  ByteBufferMessageSet msgs=KafkaUtils.fetchMessages(_spoutConfig,_consumer,_partition,offset);
  long end=System.nanoTime();
  long millis=(end - start) / 1000000;
  _fetchAPILatencyMax.update(millis);
  _fetchAPILatencyMean.update(millis);
  _fetchAPICallCount.incr();
  if (msgs != null) {
    int numMessages=0;
    for (    MessageAndOffset msg : msgs) {
      final Long cur_offset=msg.offset();
      if (cur_offset < offset) {
        continue;
      }
      if (!had_failed || failedReady.contains(cur_offset)) {
        numMessages+=1;
        _pending.add(cur_offset);
        _waitingToEmit.add(new MessageAndRealOffset(msg.message(),cur_offset));
        _emittedToOffset=Math.max(msg.nextOffset(),_emittedToOffset);
        if (had_failed) {
          failed.remove(cur_offset);
        }
      }
    }
    _fetchAPIMessageCount.incrBy(numMessages);
  }
}
