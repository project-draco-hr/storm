{
  StaticHosts hosts=(StaticHosts)config.hosts;
  long offset;
  if (lastMeta != null) {
    if (config.forceFromStart && !topologyInstanceId.equals(lastMeta.get("instanceId"))) {
      offset=consumer.getOffsetsBefore(config.topic,partition % hosts.partitionsPerHost,config.startOffsetTime,1)[0];
    }
 else {
      offset=(Long)lastMeta.get("nextOffset");
    }
  }
 else {
    long startTime=-1;
    if (config.forceFromStart)     startTime=config.startOffsetTime;
    offset=consumer.getOffsetsBefore(config.topic,partition % hosts.partitionsPerHost,startTime,1)[0];
  }
  ByteBufferMessageSet msgs;
  try {
    msgs=consumer.fetch(new FetchRequest(config.topic,partition % hosts.partitionsPerHost,offset,config.fetchSizeBytes));
  }
 catch (  Exception e) {
    if (e instanceof ConnectException) {
      throw new FailedFetchException(e);
    }
 else {
      throw new RuntimeException(e);
    }
  }
  long endoffset=offset;
  for (  MessageAndOffset msg : msgs) {
    emit(config,attempt,collector,msg.message());
    endoffset=msg.offset();
  }
  Map newMeta=new HashMap();
  newMeta.put("offset",offset);
  newMeta.put("nextOffset",endoffset);
  newMeta.put("instanceId",topologyInstanceId);
  return newMeta;
}
