{
  long available=buf.readableBytes();
  if (available < 2) {
    return null;
  }
  buf.markReaderIndex();
  int thriftLen=buf.readInt();
  available-=4;
  if (available < thriftLen) {
    buf.resetReaderIndex();
    return null;
  }
  buf.discardReadBytes();
  HBMessage m;
  if (buf.hasArray()) {
    m=Utils.thriftDeserialize(HBMessage.class,buf.array(),0,thriftLen);
    buf.readerIndex(buf.readerIndex() + thriftLen);
  }
 else {
    byte serialized[]=new byte[thriftLen];
    buf.readBytes(serialized,0,thriftLen);
    m=Utils.thriftDeserialize(HBMessage.class,serialized);
  }
  if (m.get_type() == HBServerMessageType.CONTROL_MESSAGE) {
    ControlMessage cm=ControlMessage.read(m.get_data().get_message_blob());
    return cm;
  }
 else   if (m.get_type() == HBServerMessageType.SASL_MESSAGE_TOKEN) {
    SaslMessageToken sm=SaslMessageToken.read(m.get_data().get_message_blob());
    return sm;
  }
 else {
    return m;
  }
}
