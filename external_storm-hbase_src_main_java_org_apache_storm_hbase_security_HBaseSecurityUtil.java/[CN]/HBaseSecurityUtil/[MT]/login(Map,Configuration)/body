{
  AccessControlContext context=AccessController.getContext();
  Subject subject=Subject.getSubject(context);
  if (subject != null) {
    Set<Credentials> privateCredentials=subject.getPrivateCredentials(Credentials.class);
    if (privateCredentials != null) {
      for (      Credentials cred : privateCredentials) {
        Collection<Token<? extends TokenIdentifier>> allTokens=cred.getAllTokens();
        if (allTokens != null) {
          for (          Token<? extends TokenIdentifier> token : allTokens) {
            UserGroupInformation.getCurrentUser().addToken(token);
            LOG.info("Added Hbase delegation tokens to UGI.");
          }
        }
      }
    }
  }
  UserProvider provider=UserProvider.instantiate(hbaseConfig);
  if (conf.get(TOPOLOGY_AUTO_CREDENTIALS) == null || !(((List)conf.get(TOPOLOGY_AUTO_CREDENTIALS)).contains(AutoHBase.class.getName()))) {
    LOG.info("Logging in using keytab as AutoHBase is not specified for " + TOPOLOGY_AUTO_CREDENTIALS);
    if (UserGroupInformation.isSecurityEnabled()) {
      String keytab=(String)conf.get(STORM_KEYTAB_FILE_KEY);
      if (keytab != null) {
        hbaseConfig.set(STORM_KEYTAB_FILE_KEY,keytab);
      }
      String userName=(String)conf.get(STORM_USER_NAME_KEY);
      if (userName != null) {
        hbaseConfig.set(STORM_USER_NAME_KEY,userName);
      }
      provider.login(STORM_KEYTAB_FILE_KEY,STORM_USER_NAME_KEY,InetAddress.getLocalHost().getCanonicalHostName());
    }
  }
  return provider;
}
