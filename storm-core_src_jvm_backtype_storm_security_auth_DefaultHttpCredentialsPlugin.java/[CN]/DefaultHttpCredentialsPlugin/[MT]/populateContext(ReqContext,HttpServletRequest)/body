{
  String userName=getUserName(req);
  String doAsUser=req.getHeader("doAsUser");
  if (doAsUser == null) {
    doAsUser=req.getParameter("doAsUser");
  }
  if (doAsUser != null) {
    context.setRealPrincipal(new SingleUserPrincipal(userName));
    userName=doAsUser;
  }
  if (userName != null) {
    Subject s=new Subject();
    Principal p=new SingleUserPrincipal(userName);
    s.getPrincipals().add(p);
    context.setSubject(s);
  }
  return context;
}
