{
  try {
    _process.writeMessage(query);
    while (true) {
      JSONObject action=_process.readMessage();
      String command=(String)action.get("command");
      if (command.equals("sync")) {
        return;
      }
 else       if (command.equals("log")) {
        String msg=(String)action.get("msg");
        LOG.info("Shell msg: " + msg);
      }
 else       if (command.equals("emit")) {
        String stream=(String)action.get("stream");
        if (stream == null)         stream=Utils.DEFAULT_STREAM_ID;
        Long task=(Long)action.get("task");
        List<Object> tuple=(List)action.get("tuple");
        Object messageId=(Object)action.get("id");
        if (task == null) {
          List<Integer> outtasks=_collector.emit(stream,tuple,messageId);
          Object need_task_ids=action.get("need_task_ids");
          if (need_task_ids == null || ((Boolean)need_task_ids).booleanValue()) {
            _process.writeMessage(outtasks);
          }
        }
 else {
          _collector.emitDirect((int)task.longValue(),stream,tuple,messageId);
        }
      }
 else       if (command.equals("metrics")) {
        handleMetrics(action);
      }
    }
  }
 catch (  IOException e) {
    throw new RuntimeException(e);
  }
}
