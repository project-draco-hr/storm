{
  Object maxPending=stormConf.get(Config.TOPOLOGY_SHELLBOLT_MAX_PENDING);
  if (maxPending != null) {
    this._pendingWrites=new LinkedBlockingQueue(((Number)maxPending).intValue());
  }
  _rand=new Random();
  _process=new ShellProcess(_command);
  _collector=collector;
  _context=context;
  try {
    Number subpid=_process.launch(stormConf,context);
    LOG.info("Launched subprocess with pid " + subpid);
  }
 catch (  IOException e) {
    throw new RuntimeException("Error when launching multilang subprocess\n" + _process.getErrorsString(),e);
  }
  _readerThread=new Thread(new Runnable(){
    public void run(){
      while (_running) {
        try {
          JSONObject action=_process.readMessage();
          if (action == null) {
          }
          String command=(String)action.get("command");
          if (command.equals("ack")) {
            handleAck(action);
          }
 else           if (command.equals("fail")) {
            handleFail(action);
          }
 else           if (command.equals("error")) {
            handleError(action);
          }
 else           if (command.equals("log")) {
            String msg=(String)action.get("msg");
            LOG.info("Shell msg: " + msg);
          }
 else           if (command.equals("emit")) {
            handleEmit(action);
          }
 else           if (command.equals("metrics")) {
            handleMetrics(action);
          }
        }
 catch (        InterruptedException e) {
        }
catch (        Throwable t) {
          die(t);
        }
      }
    }
  }
);
  _readerThread.start();
  _writerThread=new Thread(new Runnable(){
    public void run(){
      while (_running) {
        try {
          Object write=_pendingWrites.poll(1,SECONDS);
          if (write != null) {
            _process.writeMessage(write);
          }
          _process.drainErrorStream();
        }
 catch (        InterruptedException e) {
        }
catch (        Throwable t) {
          die(t);
        }
      }
    }
  }
);
  _writerThread.start();
}
