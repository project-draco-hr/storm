{
  MessageBatch batch=new MessageBatch(buffer_size);
  Object msg=message_queue.take();
  batch.add(msg);
  if (msg == ControlMessage.CLOSE_MESSAGE)   return batch;
  while (!batch.isFull()) {
    msg=message_queue.peek();
    if (msg == null)     break;
    if (msg == ControlMessage.CLOSE_MESSAGE) {
      message_queue.take();
      batch.add(msg);
      break;
    }
    if (!batch.tryAdd((TaskMessage)msg))     break;
    message_queue.take();
  }
  return batch;
}
