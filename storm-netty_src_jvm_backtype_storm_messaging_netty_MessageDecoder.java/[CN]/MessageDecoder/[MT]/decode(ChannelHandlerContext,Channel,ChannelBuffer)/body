{
  if (buf.readableBytes() < 2) {
    return null;
  }
  buf.markReaderIndex();
  short code=buf.readShort();
  if (code <= ControlMessage.BASE_CODE) {
    ControlMessage ctrl_msg=new ControlMessage(code);
    LOG.debug("Control message:" + ctrl_msg);
    return ctrl_msg;
  }
  short task=code;
  if (buf.readableBytes() < 4) {
    buf.resetReaderIndex();
    return null;
  }
  int length=buf.readInt();
  if (length == 0) {
    return new TaskMessage(task,null);
  }
  if (buf.readableBytes() < length) {
    buf.resetReaderIndex();
    return null;
  }
  ChannelBuffer payload=buf.readBytes(length);
  return new TaskMessage(task,payload.array());
}
